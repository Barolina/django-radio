{% extends "admin/change_list.html" %}
{% load static %}
{% load i18n %}

{% block extrastyle %}
        <link rel="stylesheet" href="{% static "fullcalendar/dist/fullcalendar.min.css" %}" type="text/css" />
        <link rel="stylesheet" href="{% static "fullcalendar/dist/fullcalendar.print.css" %}" type="text/css" media='print'/>
{% endblock %}

{% block extrahead %}
        <script src="{% static "jquery/dist/jquery.min.js" %}" type="text/javascript"></script>
        <script src="{% static "jquery-ui/jquery-ui.min.js" %}" type="text/javascript"></script>
        <script src="{% static "moment/min/moment.min.js" %}" type="text/javascript"></script>
        <script src="{% static "fullcalendar/dist/fullcalendar.js" %}" type="text/javascript"></script>
        <script src="{% static "fullcalendar/dist/lang-all.js" %}" type="text/javascript"></script>

        <script>

        function alert(msg) {
            message(msg, "error");
        }

        function info(msg) {
            message(msg, "info");
        }

        function success(msg) {
            message(msg, "success");
        }


        function message(msg, tag) {
            $("<li>").append(msg)
                .addClass("grp-" + tag)
                .fadeIn(800).delay(5000).fadeOut(800, function() {
                    this.remove();
                    if (!$("#messages>li").size()) $("#messages").slideUp();
                })
                .appendTo("#messages");
            $("#messages").slideDown();
        }

        // using jQuery
        function getCookie(name) {
            var cookieValue = null;
            if (document.cookie && document.cookie != '') {
                var cookies = document.cookie.split(';');
                for (var i = 0; i < cookies.length; i++) {
                    var cookie = jQuery.trim(cookies[i]);
                    // Does this cookie string begin with the name we want?
                    if (cookie.substring(0, name.length + 1) == (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
        var csrftoken = getCookie('csrftoken');

        function csrfSafeMethod(method) {
            // these HTTP methods do not require CSRF protection
            return (/^(GET|HEAD|OPTIONS|TRACE)$/.test(method));
        }

        function sameOrigin(url) {
            // test that a given url is a same-origin URL
            // url could be relative or scheme relative or absolute
            var host = document.location.host; // host + port
            var protocol = document.location.protocol;
            var sr_origin = '//' + host;
            var origin = protocol + sr_origin;
            // Allow absolute or scheme relative URLs to same origin
            return (url == origin || url.slice(0, origin.length + 1) == origin + '/') ||
                (url == sr_origin || url.slice(0, sr_origin.length + 1) == sr_origin + '/') ||
            // or any other URL that isn't scheme relative or absolute i.e relative.
            !(/^(\/\/|http:|https:).*/.test(url));
        }
        $.ajaxSetup({
            beforeSend: function (xhr, settings) {
                if (!csrfSafeMethod(settings.type) && sameOrigin(settings.url)) {
                    // Send the token to same-origin, relative URLs only.
                    // Send the token only if the method warrants CSRF protection
                    // Using the CSRFToken value acquired earlier
                    xhr.setRequestHeader("X-CSRFToken", csrftoken);
                }
            },
            complete: function (data) {
                        //loading(false);
                }
        });

        $(document).ready(function () {
            reloadProgrammes();

            $("#select-board").change(function() {
                    $('#calendar').fullCalendar( 'removeEvents')
                    $('#calendar').fullCalendar( 'refetchEvents')
                    reloadProgrammes()
            });

            $("#sources").submit(function(event) {
                $.ajax({
                    type: "PATCH",  // XXX this is just for transition, we want to have a PUT here
                    url: "{% url 'api:schedule-list' %}/" + $("#sources").data("schedule"),
                    data: {
                        source: $("#schedules").val()
                    },
                    success: function (res) {
                        success('Successfully added source for broadcast');
                    },
                    error: function (data) {
                        alert('{% trans "There was an error in the request" %}');
                    },
                });
                event.preventDefault();
            });

            var calendar = $('#calendar').fullCalendar({
                height: 'auto',
                contentHeight: 'auto',
                aspectRatio: 1.35,
                lang: '{{language}}',
                eventDurationEditable: false,
                eventStartEditable: true,
                allDaySlot: false,
                //firstDay: {{first_day}},
                //defaultDate: '2011-08-0{{first_day}}',
                axisFormat: 'HH:mm',
                timezone: false,
                //scrollTime: '{{scroll_time}}',
                lazyFetching: false,
                header: {
                    left: '',
                    center: '',
                    right: ''
                },
                columnFormat: {
                    month: 'ddd',    // Mon
                    week: 'dddd',        // Monday
                    day: 'dddd'     
                },
                defaultView: 'agendaWeek',

                events: {
                    url: '{% url "api:schedule-list" %}',
                    data: function() { // a function that returns an object
                        return {
                                scheduleBoardId: $( "#select-board" ).val(),
                                //firstDay: {{first_day}}
                        };
                    },

                    error: function() {
                        alert('{% trans "There was an error while fetching programmes" %}');
                    },
                },
                droppable: true, // this allows things to be dropped onto the calendar !!!
                drop: function (date) { // this function is called when something is dropped

                    var Event = {};
                    Event.programme = $(this).data('id');
                    Event.title = $(this).data('title');
                    Event.runtime = $(this).data('runtime');

                    // assign it the date that was reported
                    Event.start = date;
                    Event.end = moment(date).add(Event.runtime, 'minutes');

                    // create the event 
                    $.ajax({
                        type: "POST",
                        url: "{% url 'api:schedule-list' %}",
                        data: {
                            programme: $(this).data('id'),
                            schedule_board: $("#select-board").val(),
                            start_hour: date.format("H:mm"),
                            day: date.day(),
                            type: $("input[name='group1']:checked").val()
                        },
                        success: function(schedule) {
                            Event.id = schedule.id;
                            Event.backgroundColor = schedule.backgroundColor;
                            Event.textColor = schedule.textColor;
                            Event.type = schedule.type;
                            Event.source = schedule.source;
                            // render the event on the calendar
                            // the last `true` argument determines if the event "sticks" (http://arshaw.com/fullcalendar/docs/event_rendering/renderEvent/)
                            $('#calendar').fullCalendar('renderEvent', Event, true);
                        },
                        error: function (data) {
                            alert('{% trans "There was an error while creating schedule" %}');
                        },
                    });

                },

                //remove all events (dropped events)
                viewRender: function( view, element ){
                        $('#calendar').fullCalendar( 'removeEvents')
                },

                eventClick: function (calEvent, jsEvent, view) {
                    if (calEvent.type == 'B') {
                        $('#sources').data("schedule", calEvent.id);
                        reloadSourceSchedules(calEvent);
                        $('#sources').slideDown();
                        jsEvent.preventDefault();
                    } else {
                        $('#sources').removeData("schedule");
                        $('#sources').slideUp();
                    }
                },


                eventDrop: function (event, delta, revertFunc) {
                    $.ajax({
                        type: "PATCH",  // XXX this is just for transition, we want to have a PUT here
                        url: "{% url 'api:schedule-list' %}/" + event.id,
                        data: {
                            id: event.id,
                            start_hour: event.start.format("HH:mm"),
                            day: event.start.day(),
                        },
                        success: function (res) { },
                        error: function (data) {
                            revertFunc();
                            alert('{% trans "There was an error in the request" %}');
                        },
                    });
                },

                eventDragStop: function(event, jsEvent, ui, view) { 
                     if (isElemOverDiv(jsEvent, $('#programmes'))) {
                         $.ajax({
                             type: "POST",
                             url: "delete_schedule",
                             data: 'scheduleId=' + event.id,
                             success: function (res) {
                                 if (res.error) {
                                     alert("Error en la peticion " + res.error);
                                 } else {
                                         calendar.fullCalendar('removeEvents', event.id);
                                 }
                             },
                             error: function (data) {
                                 revertFunc();
                                 alert('{% trans "There was an error in the request" %}');
                             },
                         });
                     }
                 },
            })

        });

        function reloadProgrammes() {
            $('#programmes').empty();
            $.getJSON({
                url: "{% url 'api:programme-list' %}",
                data: { scheduleBoardId: $( "#select-board" ).val() },
                success: function(programmes) {
                    for (var i=0; i<programmes.length; i++) {
                        var programme = programmes[i];

                        $("<div>").append(programme.name)
                            .addClass("programme grp-row")
                            .data('id', programme.id)
                            .data('title', programme.name)
                            .data('runtime', programme.runtime / 60)
                            .draggable({
                                zIndex: 999,
                                revert: true, // will cause the event to go back to its
                                revertDuration: 0
                            })
                            .appendTo('#programmes');
                    }
                    info('{% trans "Programmes reloaded" %}');
                },
                error: function (data) {
                    alert('{% trans "There was an error in the request" %}');
                    revertFunc();
                },
         });
        }

        function reloadSourceSchedules(schedule) {
            $('#schedules').empty();
            $.getJSON({
                url: "{%url 'api:schedule-list' %}",
                data: {
                    schedule_board: $("#select-board").val(),
                    programme: schedule.programme,
                    type: 'L'
                },
                success: function(schedules) {
                    $("<option>").append("Without reference")
                        .addClass("source")
                        .attr('value', '')
                        .appendTo('#schedules');

                    for (var i=0; i<schedules.length; i++) {
                        var schedule = schedules[i];
                        $("<option>").append(schedule.start)
                            .addClass("source")
                            .attr('value', schedule.id)
                            .appendTo('#schedules');
                    }

                    $('#schedules').val(schedule.source); // XXX fixme
                }
            });
        }


        var isElemOverDiv = function(draggedItem, dropArea) {
            var draggedX = draggedItem.pageX;
            var draggedY = draggedItem.pageY;

            var b = $(dropArea);
            var limitX = parseInt(b.offset().left) + parseInt(b.outerWidth());
            var limitY = parseInt(b.offset().top) + parseInt(b.outerHeight());

            // Compare
            if ( limitY >=   parseInt(draggedY) 
                && limitX >=   parseInt(draggedX) ) 
            { 
                return true; 
            }
            return false;
        }
        </script>
{% endblock %}

{% block messages %}
<ul id="messages" class="grp-messagelist" style="display:{% if messages %}block{% else %}none{% endif %}">
    {% for message in messages %}
        <li{% if message.tags %} class="grp-{{ message.tags }}"{% endif %}>{{ message }}</li>
    {% endfor %}
</ul>
{% endblock %}

{% block content %}
<div  class="l-2c-fluid l-d-6">
    <div class="c-1">
        <div class="grp-module">
            <h2>{% trans "Schedule board" %}</h2>
            <div class="grp-module">
                <select id="select-board" class="form-control">
                    {% for scheduleBoard in scheduleBoards %}
                    <option value="{{scheduleBoard.id}}"
                            {% if scheduleBoard == current_scheduleBoard %}
                                    selected="selected"
                            {% endif %}>
                            {{scheduleBoard.name}}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="grp-group">
            <h2>Selection</h2>
            <!-- <div class="grp-module" id='external-events'> -->
            <div class="grp-module">
                <h3>{% trans "Programmes" %}</h3>
                <span id="programmes" />
            </div>
            <div class="grp-module">
                <h3>{% trans "Emission type" %}</h3>
                <label for="live" class="grp-row">
                    <input type="radio" name="group1" id="live" value="L" checked />
                    {% trans "live" %}
                </label>
                <label for="broadcast" class="grp-row">
                    <input type="radio" name="group1" id="broadcast" value="B" />
                    {% trans "broadcast" %}
                </label>
                <label for="broadcast-syn" class="grp-row">
                    <input type="radio" name="group1" id="broadcast-syn" value="S">
                    {% trans "broadcast syndication" %}
                </label>
            </div>
        </div>
    </div>
    <div class="c-2 grp-group grp-stacked">
        <h2>Schedules</h2>
        <form  class="grp-module" id="sources" style="display:none">
            <label for="schedules" class="grp-row">Source
                <select id="schedules" class="form-control">
                </select>
            <input class="grp-button grp-default" type="submit" name="_source" value="Save" />
            </label>
        </form>
        <div id='calendar'></div>
    </div>
  </div>
{% endblock %}
